<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Play & Earn Points</title>
  <style>
    :root{
      --bg1:#0b1020;
      --bg2:#0b2a4a;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --good:#44f27c;
      --warn:#ffd84d;
      --bad:#ff6b6b;
      --accent:#7c6dff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: radial-gradient(1000px 500px at 30% 10%, #2a3cff33, transparent 60%),
                  radial-gradient(900px 600px at 70% 25%, #00ffd533, transparent 60%),
                  linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .top{
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      padding:12px 14px;border:1px solid var(--border);background:var(--card);border-radius:16px;
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;gap:10px;align-items:center}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, #7c6dff, #00ffd5);
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
    }
    .brand h1{margin:0;font-size:16px;letter-spacing:.4px}
    .tag{font-size:12px;color:var(--muted)}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card2);
      font-size:12px;color:var(--muted);
    }
    .pill b{color:var(--text);font-weight:800}
    .row{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:920px){ .row{grid-template-columns: 1.1fr .9fr;} }
    .card{
      border:1px solid var(--border);background:var(--card);
      border-radius:18px;padding:14px;backdrop-filter: blur(10px);
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
    }
    .card h2{margin:0 0 10px;font-size:14px;letter-spacing:.3px}
    .muted{color:var(--muted);font-size:12px;line-height:1.4}
    .grid3{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:650px){ .grid3{grid-template-columns:1fr 1fr 1fr;} }
    .mini{
      border:1px solid var(--border);background:var(--card2);
      border-radius:16px;padding:12px;
    }
    .mini .k{font-size:11px;color:var(--muted)}
    .mini .v{font-size:18px;font-weight:900;margin-top:4px}
    .mini .sub{font-size:11px;color:var(--muted);margin-top:4px}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      border:0;cursor:pointer;color:white;font-weight:900;letter-spacing:.2px;
      padding:10px 12px;border-radius:14px;
      background: linear-gradient(135deg, var(--accent), #00ffd5);
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
    }
    button.secondary{
      background: transparent;border:1px solid var(--border);box-shadow:none;color:var(--text);
    }
    button.danger{
      background: linear-gradient(135deg, var(--bad), #ffb86b);
    }
    button:disabled{opacity:.45;cursor:not-allowed}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tab{
      padding:8px 10px;border-radius:999px;border:1px solid var(--border);
      background:transparent;color:var(--muted);font-size:12px;font-weight:800;cursor:pointer;
    }
    .tab.active{background:var(--card2);color:var(--text)}
    .list{display:grid;gap:10px;margin-top:12px}
    .item{
      border:1px solid var(--border);background:var(--card2);
      border-radius:16px;padding:12px;display:flex;gap:10px;align-items:center;justify-content:space-between;
    }
    .item .left{display:flex;gap:10px;align-items:center}
    .icon{
      width:42px;height:42px;border-radius:14px;border:1px solid var(--border);
      display:flex;align-items:center;justify-content:center;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.15), transparent 60%);
      font-size:20px;
    }
    .item h3{margin:0;font-size:13px}
    .item .meta{font-size:11px;color:var(--muted);margin-top:2px}
    .price{font-size:12px;color:var(--muted);text-align:right}
    .price b{display:block;color:var(--text);font-size:13px}
    .two{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:650px){ .two{grid-template-columns:1fr 1fr;} }
    input, select{
      width:100%;padding:10px 12px;border-radius:14px;
      border:1px solid var(--border);background:rgba(0,0,0,.25);
      color:var(--text);outline:none;
    }
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    .toast{
      margin-top:10px;padding:10px 12px;border-radius:14px;border:1px solid var(--border);
      background:rgba(0,0,0,.25);font-size:12px;color:var(--muted);
    }
    .good{color:var(--good);font-weight:900}
    .warn{color:var(--warn);font-weight:900}
    .bad{color:var(--bad);font-weight:900}
    .hr{height:1px;background:var(--border);margin:12px 0}
    .table{
      width:100%;border-collapse:collapse;margin-top:8px;font-size:12px;color:var(--muted);
    }
    .table th,.table td{padding:8px;border-bottom:1px solid rgba(255,255,255,.10);text-align:left}
    .right{text-align:right}
    .tiny{font-size:11px;color:var(--muted)}
    .hide{display:none}

    /* Loader */
    .overlay{
      position:fixed;inset:0;display:none;align-items:center;justify-content:center;
      background:rgba(0,0,0,.55);backdrop-filter: blur(8px);z-index:9999;
    }
    .loaderBox{
      width:min(420px, 92vw);
      border:1px solid var(--border);background:var(--card);
      border-radius:18px;padding:16px;text-align:center;
      box-shadow: 0 18px 40px rgba(0,0,0,.35);
    }
    .spinner{
      width:44px;height:44px;border-radius:50%;
      border:4px solid rgba(255,255,255,.18);
      border-top-color: #00ffd5;
      margin:10px auto 8px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    a{color:#a9a2ff;text-decoration:none}
  </style>
</head>

<body>
  <div class="overlay" id="overlay">
    <div class="loaderBox">
      <div class="spinner"></div>
      <div style="font-weight:900">Loading...</div>
      <div class="tiny" id="loadText">Please wait</div>
    </div>
  </div>

  <div class="wrap" id="landing">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Play & Earn Points</h1>
          <div class="tag">Buy workers ‚Üí auto income over time ‚Üí withdraw request</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <div class="pill">Start: <b id="startDate">11.12.2025</b></div>
        <div class="pill">Players: <b id="playersCount">50414</b></div>
        <div class="pill">Online: <b id="onlineCount">6213</b></div>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h2>About</h2>
        <div class="muted">
          ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‚ÄúPoints‚Äù ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ó‡ßá‡¶Æ-‡¶ï‡ßç‡¶∞‡ßá‡¶°‡¶ø‡¶ü‡•§ Worker ‡¶ï‡¶ø‡¶®‡¶≤‡ßá income/hour ‡¶¨‡¶æ‡ßú‡ßá ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Æ‡ßü ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ points auto ‡¶¨‡¶æ‡ßú‡ßá‡•§
        </div>

        <div class="hr"></div>

        <h2>Top Users (Sample)</h2>
        <table class="table">
          <thead>
            <tr><th>Nick</th><th class="right">Income / day</th><th class="right">Points</th></tr>
          </thead>
          <tbody id="topUsers"></tbody>
        </table>

        <div class="tiny" style="margin-top:8px">
          Referral link: <span id="refLink"></span>
        </div>
      </div>

      <div class="card" id="authCard">
        <h2>Login / Register</h2>
        <div class="muted">
          New account bonus: <b class="good">+5000 points</b><br/>
          Referral bonus: <b class="good">+500 points</b> (referrer)
        </div>

        <div class="toast" id="notice">
          <span class="warn">Note:</span> 1 device = 1 account (best-effort, browser-based).
        </div>

        <label>Username</label>
        <input id="uName" placeholder="Enter your username" />

        <label>Password</label>
        <input id="uPass" type="password" placeholder="Create password" />

        <div class="btnrow">
          <button onclick="register()">Register</button>
          <button class="secondary" onclick="login()">Login</button>
        </div>

        <div class="toast" id="msg"><span class="warn">Not logged in.</span></div>

        <div class="btnrow">
          <button class="secondary" onclick="goAppIfLogged()">Go Dashboard</button>
          <button class="danger" onclick="resetAll()">Reset Data</button>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="wrap hide" id="app">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Dashboard</h1>
          <div class="tag" id="who">User: Guest</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
        <div class="pill">Points: <b id="points">0</b></div>
        <div class="pill">Income: <b id="rate">0</b> / hour</div>
        <button class="secondary" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="row">
      <div class="card">
        <h2>Overview</h2>

        <div class="grid3">
          <div class="mini">
            <div class="k">Balance</div>
            <div class="v" id="balBox">0</div>
            <div class="sub">Points</div>
          </div>
          <div class="mini">
            <div class="k">Income Rate</div>
            <div class="v" id="rateBox">0</div>
            <div class="sub">Points / hour</div>
          </div>
          <div class="mini">
            <div class="k">Withdraw Requirement</div>
            <div class="v">50,000</div>
            <div class="sub">Minimum points</div>
          </div>
        </div>

        <div class="btnrow">
          <button onclick="openTab('shop')">Shop</button>
          <button class="secondary" onclick="openTab('inventory')">My Workers</button>
          <button class="secondary" onclick="openTab('withdraw')">Withdraw</button>
          <button class="secondary" onclick="openTab('leaderboard')">Leaderboard</button>
          <button class="secondary" onclick="openTab('history')">History</button>
        </div>

        <div class="hr"></div>

        <div class="tabs">
          <div class="tab active" id="tab-shop" onclick="openTab('shop')">Shop</div>
          <div class="tab" id="tab-inventory" onclick="openTab('inventory')">My Workers</div>
          <div class="tab" id="tab-withdraw" onclick="openTab('withdraw')">Withdraw</div>
          <div class="tab" id="tab-leaderboard" onclick="openTab('leaderboard')">Leaderboard</div>
          <div class="tab" id="tab-history" onclick="openTab('history')">History</div>
        </div>

        <div id="panel-shop" class="list"></div>

        <div id="panel-inventory" class="hide">
          <div class="two">
            <div class="mini">
              <div class="k">Total Workers</div>
              <div class="v" id="wCount">0</div>
              <div class="sub">Owned</div>
            </div>
            <div class="mini">
              <div class="k">Lifetime Earned</div>
              <div class="v" id="life">0</div>
              <div class="sub">Points</div>
            </div>
          </div>
          <div class="hr"></div>
          <div class="muted">Owned Workers</div>
          <div class="list" id="ownedList"></div>
        </div>

        <div id="panel-withdraw" class="hide">
          <div class="toast">
            Withdraw request ‡¶∂‡ßÅ‡¶ß‡ßÅ log ‡¶π‡ßü‡•§ Real payout ‡¶ï‡¶∞‡¶§‡ßá backend ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá‡•§
          </div>

          <label>Method</label>
          <select id="wMethod">
            <option>USDT (TRC20)</option>
            <option>USDT (BEP20)</option>
            <option>Bank / Mobile (Manual)</option>
          </select>

          <label>Account / Wallet</label>
          <input id="wAcc" placeholder="Enter account / wallet" />

          <label>Amount (Points)</label>
          <input id="wAmt" type="number" min="0" step="1" placeholder="e.g., 50000" />

          <div class="btnrow">
            <button onclick="requestWithdraw()">Request</button>
            <button class="secondary" onclick="fillWithdraw()">Auto Fill</button>
          </div>

          <div class="hr"></div>
          <div class="muted">Withdraw Requests</div>
          <table class="table" id="wTable">
            <thead><tr><th>Date</th><th>Method</th><th class="right">Amount</th><th>Status</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="panel-leaderboard" class="hide">
          <div class="muted">Score = Points + (Income/hour √ó 2)</div>
          <table class="table" id="lbTable">
            <thead><tr><th>#</th><th>User</th><th class="right">Score</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

        <div id="panel-history" class="hide">
          <div class="muted">Recent activity</div>
          <table class="table" id="hTable">
            <thead><tr><th>Date</th><th>Action</th><th class="right">Change</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>

      </div>

      <div class="card">
        <h2>Referral</h2>
        <div class="muted">
          ‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ referral link ‡¶¶‡¶ø‡ßü‡ßá ‡¶ï‡ßá‡¶â register ‡¶ï‡¶∞‡¶≤‡ßá ‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶™‡¶æ‡¶¨‡ßá <b class="good">+500 points</b>.
        </div>
        <div class="hr"></div>
        <div class="toast">
          Your link:<br/>
          <span id="myRefLink"></span>
        </div>

        <div class="hr"></div>
        <h2>Stats</h2>
        <div class="mini">
          <div class="k">My Referrals (browser demo)</div>
          <div class="v" id="refCount">0</div>
          <div class="sub">Tracked locally</div>
        </div>

        <div class="hr"></div>
        <button class="secondary" onclick="backToLanding()">Back Home</button>
      </div>
    </div>
  </div>

<script>
  // ==========================
  // CONFIG (your rules)
  // ==========================
  const NEW_ACCOUNT_BONUS = 5000;
  const REF_BONUS_TO_REFERRER = 500;
  const WITHDRAW_MIN = 50000;

  // ==========================
  // STORAGE MODEL
  // ==========================
  const DBKEY = "pe_points_v1";

  // Workers (shop items)
  // price in points, rate in points/hour
  const WORKERS = [
    {id:"w_basic", name:"Basic Worker", icon:"üë∑", price: 1200, rate: 20, desc:"Starter worker"},
    {id:"w_fast",  name:"Fast Worker",  icon:"‚ö°", price: 3500, rate: 65, desc:"Faster income"},
    {id:"w_pro",   name:"Pro Worker",   icon:"üß†", price: 9000, rate: 180, desc:"Strong income"},
    {id:"w_team",  name:"Team Worker",  icon:"üë•", price: 22000, rate: 520, desc:"Team boost"},
    {id:"w_vip",   name:"VIP Worker",   icon:"üíé", price: 60000, rate: 1600, desc:"High income"}
  ];

  function now(){ return Date.now(); }
  function ts(t){ return new Date(t).toLocaleString(); }
  function fmtInt(n){ return String(Math.floor(n)); }
  function q(name){ return document.getElementById(name); }

  function loadDB(){
    const raw = localStorage.getItem(DBKEY);
    if(!raw){
      const deviceId = getOrCreateDeviceId();
      const init = { deviceId, users:{}, session:null, deviceUsed:false };
      localStorage.setItem(DBKEY, JSON.stringify(init));
      return init;
    }
    try{ return JSON.parse(raw); }
    catch(e){
      localStorage.removeItem(DBKEY);
      return loadDB();
    }
  }
  function saveDB(db){ localStorage.setItem(DBKEY, JSON.stringify(db)); }

  // best-effort device lock (same browser)
  function getOrCreateDeviceId(){
    const k = "pe_device_id";
    let id = localStorage.getItem(k);
    if(!id){
      id = "dev_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
      localStorage.setItem(k, id);
    }
    return id;
  }

  function getUser(db){
    if(!db.session) return null;
    return db.users[db.session] || null;
  }

  // Auto income accrual
  function computeRate(user){
    let r = 0;
    for(const o of user.owned){
      const w = WORKERS.find(x=>x.id===o.id);
      if(w) r += w.rate * o.qty;
    }
    return r; // points/hour
  }

  function accrue(db){
    const user = getUser(db);
    if(!user) return;
    const t = now();
    const dt = Math.max(0, t - user.lastTick);
    user.lastTick = t;

    const rateH = computeRate(user);
    const rateMs = rateH / (3600*1000);
    const earned = rateMs * dt;

    if(earned > 0){
      user.points += earned;
      user.lifetime += earned;
    }
  }

  // --------------------------
  // Landing fake stats + top list
  // --------------------------
  function setLandingStats(){
    const basePlayers = 50414;
    const baseOnline = 6213;
    q("playersCount").textContent = fmtInt(basePlayers + Math.random()*120);
    q("onlineCount").textContent  = fmtInt(baseOnline + Math.random()*80);

    // Top users sample (not ‚Äúwithdraw list‚Äù)
    const rows = [
      ["Denki",  "1086", "250000"],
      ["Dali",   "1009", "232110"],
      ["Andrea", "1002", "221400"],
      ["Noomi",  "919",  "190800"],
      ["Ayoub",  "890",  "176300"],
    ];
    const tb = q("topUsers");
    tb.innerHTML = "";
    rows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r[0]}</td><td class="right">${r[1]}</td><td class="right">${r[2]}</td>`;
      tb.appendChild(tr);
    });
  }

  function setReferralLinkUI(){
    const base = location.origin + location.pathname;
    const my = currentUsername() || "your_username";
    q("refLink").textContent = base + "?ref=" + encodeURIComponent(my);
    q("myRefLink").textContent = base + "?ref=" + encodeURIComponent(my);
  }

  function currentUsername(){
    const db = loadDB();
    return db.session;
  }

  // --------------------------
  // Tabs
  // --------------------------
  function openTab(name){
    const tabs = ["shop","inventory","withdraw","leaderboard","history"];
    for(const t of tabs){
      q("panel-"+t).classList.add("hide");
      q("tab-"+t).classList.remove("active");
    }
    q("panel-"+name).classList.remove("hide");
    q("tab-"+name).classList.add("active");
  }

  // --------------------------
  // Render Shop / Inventory
  // --------------------------
  function renderShop(){
    const db = loadDB();
    const user = getUser(db);
    const el = q("panel-shop");
    el.innerHTML = "";

    if(!user){
      el.innerHTML = `<div class="toast"><span class="warn">Login required.</span></div>`;
      return;
    }

    for(const w of WORKERS){
      const can = user.points >= w.price;
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div class="left">
          <div class="icon">${w.icon}</div>
          <div>
            <h3>${w.name}</h3>
            <div class="meta">${w.desc} ‚Ä¢ +${w.rate} points/hour</div>
          </div>
        </div>
        <div style="text-align:right">
          <div class="price"><b>${w.price} points</b><span>one-time buy</span></div>
          <button ${can ? "" : "disabled"} onclick="buyWorker('${w.id}')">${can ? "Buy" : "Low Balance"}</button>
        </div>
      `;
      el.appendChild(row);
    }
  }

  function renderInventory(){
    const db = loadDB();
    const user = getUser(db);
    const list = q("ownedList");
    list.innerHTML = "";

    if(!user){
      q("wCount").textContent = "0";
      q("life").textContent = "0";
      list.innerHTML = `<div class="toast">Login required.</div>`;
      return;
    }

    const count = user.owned.reduce((a,b)=>a+b.qty,0);
    q("wCount").textContent = String(count);
    q("life").textContent = fmtInt(user.lifetime);

    if(user.owned.length === 0){
      list.innerHTML = `<div class="toast">No workers yet. Shop ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡¶ø‡¶®‡ßã‡•§</div>`;
      return;
    }

    for(const o of user.owned){
      const w = WORKERS.find(x=>x.id===o.id);
      if(!w) continue;
      const row = document.createElement("div");
      row.className="item";
      row.innerHTML = `
        <div class="left">
          <div class="icon">${w.icon}</div>
          <div>
            <h3>${w.name} √ó ${o.qty}</h3>
            <div class="meta">Total: +${w.rate*o.qty} points/hour</div>
          </div>
        </div>
        <div class="price"><b>${w.price} points</b><span>paid</span></div>
      `;
      list.appendChild(row);
    }
  }

  // --------------------------
  // Leaderboard / History / Withdraw
  // --------------------------
  function renderLeaderboard(){
    const db = loadDB();
    const user = getUser(db);
    const tb = document.querySelector("#lbTable tbody");
    tb.innerHTML = "";

    const bots = [
      {u:"alpha_whale", points: 180000, rate: 900},
      {u:"hash_master", points: 140000, rate: 700},
      {u:"rig_king",    points: 110000, rate: 520},
      {u:"pool_vip",    points: 95000,  rate: 410},
      {u:"fast_miner",  points: 65000,  rate: 260},
    ];

    let all = bots.map(b=>({u:b.u, score: b.points + b.rate*2}));
    if(user){
      const r = computeRate(user);
      const score = user.points + r*2;
      all.push({u: db.session, score});
    }
    all.sort((a,b)=>b.score-a.score);
    all.slice(0,10).forEach((r,i)=>{
      const me = (user && r.u === db.session);
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${i+1}</td><td>${me?`<span class="good">${r.u} (you)</span>`:r.u}</td><td class="right">${fmtInt(r.score)}</td>`;
      tb.appendChild(tr);
    });
  }

  function renderHistory(){
    const db = loadDB();
    const user = getUser(db);
    const tb = document.querySelector("#hTable tbody");
    tb.innerHTML = "";
    if(!user){
      tb.innerHTML = `<tr><td colspan="3">Login required.</td></tr>`;
      return;
    }
    if(user.history.length === 0){
      tb.innerHTML = `<tr><td colspan="3">No activity.</td></tr>`;
      return;
    }
    user.history.slice(0,50).forEach(h=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${ts(h.t)}</td><td>${h.action}</td><td class="right">${h.change}</td>`;
      tb.appendChild(tr);
    });
  }

  function renderWithdrawTable(){
    const db = loadDB();
    const user = getUser(db);
    const tb = document.querySelector("#wTable tbody");
    tb.innerHTML = "";
    if(!user){
      tb.innerHTML = `<tr><td colspan="4">Login required.</td></tr>`;
      return;
    }
    if(user.withdraws.length === 0){
      tb.innerHTML = `<tr><td colspan="4">No requests.</td></tr>`;
      return;
    }
    user.withdraws.forEach(w=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${ts(w.t)}</td><td>${w.method}</td><td class="right">${fmtInt(w.amt)}</td><td><span class="warn">${w.status}</span></td>`;
      tb.appendChild(tr);
    });
  }

  // --------------------------
  // Actions
  // --------------------------
  function buyWorker(id){
    const db = loadDB();
    const user = getUser(db);
    if(!user) return;

    accrue(db);
    const w = WORKERS.find(x=>x.id===id);
    if(!w) return;

    if(user.points < w.price){
      setMsg(`Balance ‡¶ï‡¶Æ‡•§ ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ${w.price} points`, "bad");
      saveDB(db);
      renderAll();
      return;
    }

    user.points -= w.price;
    const owned = user.owned.find(o=>o.id===id);
    if(owned) owned.qty += 1;
    else user.owned.push({id, qty:1});

    user.history.unshift({t:now(), action:`Bought: ${w.name}`, change:`-${w.price}`});
    user.history = user.history.slice(0,50);

    saveDB(db);
    setMsg(`Purchased ‚úÖ ${w.name}`, "good");
    renderAll();
  }

  function requestWithdraw(){
    const db = loadDB();
    const user = getUser(db);
    if(!user) return;

    accrue(db);

    const method = q("wMethod").value;
    const acc = (q("wAcc").value||"").trim();
    const amt = Math.floor(parseFloat(q("wAmt").value||"0"));

    if(acc.length < 6) return setMsg("Account/Wallet ‡¶¶‡¶æ‡¶ì‡•§", "bad");
    if(!(amt > 0)) return setMsg("Amount ‡¶†‡¶ø‡¶ï ‡¶¶‡¶æ‡¶ì‡•§", "bad");
    if(amt < WITHDRAW_MIN) return setMsg(`Withdraw ‡¶ï‡¶∞‡¶§‡ßá minimum ${WITHDRAW_MIN} points ‡¶≤‡¶æ‡¶ó‡¶¨‡ßá‡•§`, "bad");
    if(user.points < amt) return setMsg("Balance ‡¶ï‡¶Æ‡•§", "bad");

    // deduct to simulate "hold"
    user.points -= amt;
    user.withdraws.unshift({t:now(), method, amt, status:"Pending"});
    user.withdraws = user.withdraws.slice(0,20);

    user.history.unshift({t:now(), action:"Withdraw requested", change:`-${amt}`});
    user.history = user.history.slice(0,50);

    saveDB(db);
    setMsg("Withdraw request submitted ‚úÖ", "good");
    renderAll();
  }

  function fillWithdraw(){
    q("wAcc").value = "YourWalletOrAccount";
    q("wAmt").value = WITHDRAW_MIN;
  }

  // --------------------------
  // Auth + Referral rules
  // --------------------------
  function getRefFromURL(){
    const u = new URL(location.href);
    const ref = (u.searchParams.get("ref") || "").trim().toLowerCase();
    return ref || null;
  }

  function setMsg(text, cls){
    q("msg").innerHTML = `<span class="${cls}">${text}</span>`;
  }

  function showLoader(text="Loading..."){
    q("loadText").textContent = text;
    q("overlay").style.display = "flex";
  }
  function hideLoader(){ q("overlay").style.display = "none"; }

  function register(){
    const db = loadDB();
    const userName = (q("uName").value||"").trim().toLowerCase();
    const pass = (q("uPass").value||"").trim();

    if(userName.length < 3) return setMsg("Username ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá 3 ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡•§", "bad");
    if(pass.length < 4) return setMsg("Password ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá 4 ‡¶Ö‡¶ï‡ßç‡¶∑‡¶∞‡•§", "bad");

    // 1 device = 1 account (best-effort)
    if(db.deviceUsed){
      return setMsg("‡¶è‡¶á ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏‡ßá already ‡¶è‡¶ï‡¶ü‡¶ø account ‡¶Ü‡¶õ‡ßá‡•§", "bad");
    }
    if(db.users[userName]){
      return setMsg("‡¶è‡¶á username ‡¶Ü‡¶ó‡ßá ‡¶•‡ßá‡¶ï‡ßá ‡¶Ü‡¶õ‡ßá‡•§ Login ‡¶ï‡¶∞‡ßã‡•§", "warn");
    }

    const ref = getRefFromURL();

    db.users[userName] = {
      pass,
      points: NEW_ACCOUNT_BONUS,
      lifetime: NEW_ACCOUNT_BONUS,
      lastTick: now(),
      owned: [],
      history: [{t:now(), action:"New account bonus", change:`+${NEW_ACCOUNT_BONUS}`}],
      withdraws: [],
      referredBy: ref || null
    };

    // referral bonus to referrer (if ref exists and ref user exists)
    if(ref && db.users[ref] && ref !== userName){
      db.users[ref].points += REF_BONUS_TO_REFERRER;
      db.users[ref].lifetime += REF_BONUS_TO_REFERRER;
      db.users[ref].history.unshift({t:now(), action:`Referral bonus (from ${userName})`, change:`+${REF_BONUS_TO_REFERRER}`});
      // track ref count locally (browser)
      db.users[ref].refCount = (db.users[ref].refCount||0) + 1;
    }

    db.session = userName;
    db.deviceUsed = true; // lock after first register on this device
    saveDB(db);

    setMsg("Registered ‚úÖ Bonus added + Logged in", "good");
    showLoader("Entering dashboard...");
    setTimeout(()=>{
      hideLoader();
      enterApp();
    }, 900);
  }

  function login(){
    const db = loadDB();
    const userName = (q("uName").value||"").trim().toLowerCase();
    const pass = (q("uPass").value||"").trim();

    if(!db.users[userName]) return setMsg("User ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§", "bad");
    if(db.users[userName].pass !== pass) return setMsg("Password ‡¶≠‡ßÅ‡¶≤‡•§", "bad");

    db.session = userName;
    db.users[userName].lastTick = now();
    saveDB(db);

    setMsg("Login successful ‚úÖ", "good");
    showLoader("Loading your account...");
    setTimeout(()=>{
      hideLoader();
      enterApp();
    }, 700);
  }

  function logout(){
    const db = loadDB();
    db.session = null;
    saveDB(db);
    backToLanding();
  }

  function resetAll(){
    localStorage.removeItem(DBKEY);
    localStorage.removeItem("pe_device_id");
    setMsg("All data reset ‚úÖ", "warn");
    setLandingStats();
  }

  function goAppIfLogged(){
    const db = loadDB();
    if(!db.session) return setMsg("‡¶Ü‡¶ó‡ßá Login ‡¶ï‡¶∞‡ßã‡•§", "warn");
    showLoader("Opening dashboard...");
    setTimeout(()=>{ hideLoader(); enterApp(); }, 600);
  }

  function enterApp(){
    q("landing").classList.add("hide");
    q("app").classList.remove("hide");
    openTab("shop");
    renderAll();
  }

  function backToLanding(){
    q("app").classList.add("hide");
    q("landing").classList.remove("hide");
    setLandingStats();
    setReferralLinkUI();
  }

  // --------------------------
  // Render All
  // --------------------------
  function renderHeader(){
    const db = loadDB();
    const user = getUser(db);

    if(!user){
      q("who").textContent = "User: Guest";
      q("points").textContent = "0";
      q("rate").textContent = "0";
      q("balBox").textContent = "0";
      q("rateBox").textContent = "0";
      q("refCount").textContent = "0";
      setReferralLinkUI();
      return;
    }

    accrue(db);
    saveDB(db);

    const r = computeRate(user);
    q("who").textContent = "User: " + db.session;
    q("points").textContent = fmtInt(user.points);
    q("rate").textContent = fmtInt(r);
    q("balBox").textContent = fmtInt(user.points);
    q("rateBox").textContent = fmtInt(r);
    q("refCount").textContent = String(user.refCount || 0);
    setReferralLinkUI();
  }

  function renderAll(){
    renderHeader();
    renderShop();
    renderInventory();
    renderLeaderboard();
    renderHistory();
    renderWithdrawTable();
  }

  // --------------------------
  // Tick loop
  // --------------------------
  setInterval(()=>{
    const db = loadDB();
    if(db.session){
      accrue(db);
      saveDB(db);
      renderHeader();
    }
  }, 1000);

  // init
  (function init(){
    setLandingStats();
    setReferralLinkUI();
    const db = loadDB();
    if(db.session && !db.users[db.session]){
      db.session = null;
      saveDB(db);
    }
  })();
</script>
</body>
            </html>
