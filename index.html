<div class="k">My Referrals (browser demo)</div>
          <div class="v" id="refCount">0</div>
          <div class="sub">Tracked locally</div>
        </div>

        <div class="hr"></div>
        <button class="secondary" onclick="backToLanding()">Back Home</button>
      </div>
    </div>
  </div>

<script>
  // ==========================
  // CONFIG (your rules)
  // ==========================
  const NEW_ACCOUNT_BONUS = 5000;
  const REF_BONUS_TO_REFERRER = 500;
  const WITHDRAW_MIN = 50000;

  // ==========================
  // STORAGE MODEL
  // ==========================
  const DBKEY = "pe_points_v1";

  // Workers (shop items)
  // price in points, rate in points/hour
  const WORKERS = [
    {id:"w_basic", name:"Basic Worker", icon:"ðŸ‘·", price: 1200, rate: 20, desc:"Starter worker"},
    {id:"w_fast",  name:"Fast Worker",  icon:"âš¡", price: 3500, rate: 65, desc:"Faster income"},
    {id:"w_pro",   name:"Pro Worker",   icon:"ðŸ§ ", price: 9000, rate: 180, desc:"Strong income"},
    {id:"w_team",  name:"Team Worker",  icon:"ðŸ‘¥", price: 22000, rate: 520, desc:"Team boost"},
    {id:"w_vip",   name:"VIP Worker",   icon:"ðŸ’Ž", price: 60000, rate: 1600, desc:"High income"}
  ];

  function now(){ return Date.now(); }
  function ts(t){ return new Date(t).toLocaleString(); }
  function fmtInt(n){ return String(Math.floor(n)); }
  function q(name){ return document.getElementById(name); }

  function loadDB(){
    const raw = localStorage.getItem(DBKEY);
    if(!raw){
      const deviceId = getOrCreateDeviceId();
      const init = { deviceId, users:{}, session:null, deviceUsed:false };
      localStorage.setItem(DBKEY, JSON.stringify(init));
      return init;
    }
    try{ return JSON.parse(raw); }
    catch(e){
      localStorage.removeItem(DBKEY);
      return loadDB();
    }
  }
  function saveDB(db){ localStorage.setItem(DBKEY, JSON.stringify(db)); }

  // best-effort device lock (same browser)
  function getOrCreateDeviceId(){
    const k = "pe_device_id";
    let id = localStorage.getItem(k);
    if(!id){
      id = "dev_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
      localStorage.setItem(k, id);
    }
    return id;
  }

  function getUser(db){
    if(!db.session) return null;
    return db.users[db.session] || null;
  }

  // Auto income accrual
  function computeRate(user){
    let r = 0;
    for(const o of user.owned){
      const w = WORKERS.find(x=>x.id===o.id);
      if(w) r += w.rate * o.qty;
    }
    return r; // points/hour
  }

  function accrue(db){
    const user = getUser(db);
    if(!user) return;
    const t = now();
    const dt = Math.max(0, t - user.lastTick);
    user.lastTick = t;

    const rateH = computeRate(user);
    const rateMs = rateH / (3600*1000);
    const earned = rateMs * dt;

    if(earned > 0){
      user.points += earned;
      user.lifetime += earned;
    }
  }

  // --------------------------
  // Landing fake stats + top list
  // --------------------------
  function setLandingStats(){
    const basePlayers = 50414;
    const baseOnline = 6213;
    q("playersCount").textContent = fmtInt(basePlayers + Math.random()*120);
    q("onlineCount").textContent  = fmtInt(baseOnline + Math.random()*80);

    // Top users sample (not â€œwithdraw listâ€)
    const rows = [
      ["Denki",  "1086", "250000"],
      ["Dali",   "1009", "232110"],
      ["Andrea", "1002", "221400"],
      ["Noomi",  "919",  "190800"],
      ["Ayoub",  "890",  "176300"],
    ];
    const tb = q("topUsers");
    tb.innerHTML = "";
    rows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${r[0]}</td><td class="right">${r[1]}</td><td class="right">${r[2]}</td>`;
      tb.appendChild(tr);
    });
  }

  function setReferralLinkUI(){
    const base = location.origin + location.pathname;
    const my = currentUsername() || "your_username";
    q("refLink").textContent = base + "?ref=" + encodeURIComponent(my);
    q("myRefLink").textContent = base + "?ref=" + encodeURIComponent(my);
  }

  function currentUsername(){
    const db = loadDB();
    return db.session;
  }

  // --------------------------
  // Tabs
  // --------------------------
  function openTab(name){
    const tabs = ["shop","inventory","withdraw","leaderboard","history"];
    for(const t of tabs){
      q("panel-"+t).classList.add("hide");
      q("tab-"+t).classList.remove("active");
    }
    q("panel-"+name).classList.remove("hide");
    q("tab-"+name).classList.add("active");
  }

  // --------------------------
  // Render Shop / Inventory
  // --------------------------
  function renderShop(){
    const db = loadDB();
    const user = getUser(db);
    const el = q("panel-shop");
    el.innerHTML = "";

    if(!user){
      el.innerHTML = `<div class="toast"><span class="warn">Login required.</span></div>`;
      return;
    }

    for(const w of WORKERS){
      const can = user.points >= w.price;
      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div class="left">
          <div class="icon">${w.icon}</div>
          <div>
            <h3>${w.name}</h3>
            <div class="meta">${w.desc} â€¢ +${w.rate} points/hour</div>
          </div>
        </div>
        <div style="text-align:right">
          <div class="price"><b>${w.price} points</b><span>one-time buy</span></div>
          <button ${can ? "" : "disabled"} onclick="buyWorker('${w.id}')">${can ? "Buy" : "Low Balance"}</button>
        </div>
      `;
      el.appendChild(row);
    }
  }

  function renderInventory(){
    const db = loadDB();
    const user = getUser(db);
    const list = q("ownedList");
    list.innerHTML = "";

    if(!user){
      q("wCount").textContent = "0";
      q("life").textContent = "0";
      list.innerHTML = `<div class="toast">Login required.</div>`;
      return;
    }

    const count = user.owned.reduce((a,b)=>a+b.qty,0);
    q("wCount").textContent = String(count);
    q("life").textContent = fmtInt(user.lifetime);

    if(user.owned.length === 0){
      list.innerHTML = `<div class="toast">No workers yet. Shop à¦¥à§‡à¦•à§‡ à¦•à¦¿à¦¨à§‹à¥¤</div>`;
      return;
    }

    for(const o of user.owned){
      const w = WORKERS.find(x=>x.id===o.id);
      if(!w) continue;
      const row = document.createElement("div");
      row.className="item";
      row.innerHTML = `
        <div class="left">
          <div class="icon">${w.icon}</div>
          <div>
            <h3>${w.name} Ã— ${o.qty}</h3>
            <div class="meta">Total: +${w.rate*o.qty} points/hour</div>
          </div>
        </div>
        <div class="price"><b>${w.price} points</b><span>paid</span></div>
      `;
      list.appendChild(row);
    }
  }

  // --------------------------
  // Leaderboard / History / Withdraw
  // --------------------------
  function renderLeaderboard(){
    const db = loadDB();
    const user = getUser(db);
    const tb = document.querySelector("#lbTable tbody");
    tb.innerHTML = "";

    const bots = [
      {u:"alpha_whale", points: 180000, rate: 900},
      {u:"hash_master", points: 140000, rate: 700},
      {u:"rig_king",    points: 110000, rate: 520},
      {u:"pool_vip",    points: 95000,  rate: 410},
      {u:"fast_miner",  points: 65000,  rate: 260},
    ];

    let all = bots.map(b=>({u:b.u, score: b.points + b.rate*2}));
    if(user){
      const r = computeRate(user);
      const score = user.points + r*2;
      all.push({u: db.session, score});
    }
    all.sort((a,b)=>b.score-a.score);
    all.slice(0,10).forEach((r,i)=>{
      const me = (user && r.u === db.session);
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${i+1}</td><td>${me?`<span class="good">${r.u} (you)</span>`:r.u}</td><td class="right">${fmtInt(r.score)}</td>`;
      tb.appendChild(tr);
    });
  }

  function renderHistory(){
    const db = loadDB();
    const user = getUser(db);
    const tb = document.querySelector("#hTable tbody");
    tb.innerHTML = "";
    if(!user){
      tb.innerHTML = `<tr><td colspan="3">Login required.</td></tr>`;
      return;
    }
    if(user.history.length === 0){
      tb.innerHTML = `<tr><td colspan="3">No activity.</td></tr>`;
      return;
    }
    user.history.slice(0,50).forEach(h=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${ts(h.t)}</td><td>${h.action}</td><td class="right">${h.change}</td>`;
      tb.appendChild(tr);
    });
  }

  function renderWithdrawTable(){
    const db = loadDB();
    const user = getUser(db);
    const tb = document.querySelector("#wTable tbody");
    tb.innerHTML = "";
    if(!user){
      tb.innerHTML = `<tr><td colspan="4">Login required.</td></tr>`;
      return;
    }
    if(user.withdraws.length === 0){
      tb.innerHTML = `<tr><td colspan="4">No requests.</td></tr>`;
      return;
    }
    user.withdraws.forEach(w=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${ts(w.t)}</td><td>${w.method}</td><td class="right">${fmtInt(w.amt)}</td><td><span class="warn">${w.status}</span></td>`;
      tb.appendChild(tr);
    });
  }

  // --------------------------
  // Actions
  // --------------------------
  function buyWorker(id){
    const db = loadDB();
    const user = getUser(db);
    if(!user) return;

    accrue(db);
    const w = WORKERS.find(x=>x.id===id);
    if(!w) return;

    if(user.points < w.price){
      setMsg(`Balance à¦•à¦®à¥¤ à¦¦à¦°à¦•à¦¾à¦° ${w.price} points`, "bad");
      saveDB(db);
      renderAll();
      return;
    }

    user.points -= w.price;
    const owned = user.owned.find(o=>o.id===id);
    if(owned) owned.qty += 1;
    else user.owned.push({id, qty:1});

    user.history.unshift({t:now(), action:`Bought: ${w.name}`, change:`-${w.price}`});
    user.history = user.history.slice(0,50);

    saveDB(db);
    setMsg(`Purchased âœ… ${w.name}`, "good");
    renderAll();
  }

  function requestWithdraw(){
    const db = loadDB();
    const user = getUser(db);
    if(!user) return;

    accrue(db);

    const method = q("wMethod").value;
    const acc = (q("wAcc").value||"").trim();
    const amt = Math.floor(parseFloat(q("wAmt").value||"0"));

    if(acc.length < 6) return setMsg("Account/Wallet à¦¦à¦¾à¦“à¥¤", "bad");
    if(!(amt > 0)) return setMsg("Amount à¦ à¦¿à¦• à¦¦à¦¾à¦“à¥¤", "bad");
    if(amt < WITHDRAW_MIN) return setMsg(`Withdraw à¦•à¦°à¦¤à§‡ minimum ${WITHDRAW_MIN} points à¦²à¦¾à¦—à¦¬à§‡à¥¤`, "bad");
    if(user.points < amt) return setMsg("Balance à¦•à¦®à¥¤", "bad");

    // deduct to simulate "hold"
    user.points -= amt;
    user.withdraws.unshift({t:now(), method, amt, status:"Pending"});
    user.withdraws = user.withdraws.slice(0,20);

    user.history.unshift({t:now(), action:"Withdraw requested", change:`-${amt}`});
    user.history = user.history.slice(0,50);

    saveDB(db);
    setMsg("Withdraw request submitted âœ…", "good");
    renderAll();
  }

  function fillWithdraw(){
    q("wAcc").value = "YourWalletOrAccount";
    q("wAmt").value = WITHDRAW_MIN;
  }

  // --------------------------
  // Auth + Referral rules
  // --------------------------
  function getRefFromURL(){
    const u = new URL(location.href);
    const ref = (u.searchParams.get("ref") || "").trim().toLowerCase();
    return ref || null;
  }

  function setMsg(text, cls){
    q("msg").innerHTML = `<span class="${cls}">${text}</span>`;
  }

  function showLoader(text="Loading..."){
    q("loadText").textContent = text;
    q("overlay").style.display = "flex";
  }
  function hideLoader(){ q("overlay").style.display = "none"; }

  function register(){
    const db = loadDB();
    const userName = (q("uName").value||"").trim().toLowerCase();
    const pass = (q("uPass").value||"").trim();

    if(userName.length < 3) return setMsg("Username à¦•à¦®à¦ªà¦•à§à¦·à§‡ 3 à¦…à¦•à§à¦·à¦°à¥¤", "bad");
    if(pass.length < 4) return setMsg("Password à¦•à¦®à¦ªà¦•à§à¦·à§‡ 4 à¦…à¦•à§à¦·à¦°à¥¤", "bad");

    // 1 device = 1 account (best-effort)
    if(db.deviceUsed){
      return setMsg("à¦à¦‡ à¦¡à¦¿à¦­à¦¾à¦‡à¦¸à§‡ already à¦à¦•à¦Ÿà¦¿ account à¦†à¦›à§‡à¥¤", "bad");
    }
    if(db.users[userName]){
      return setMsg("à¦à¦‡ username à¦†à¦—à§‡ à¦¥à§‡à¦•à§‡ à¦†à¦›à§‡à¥¤ Login à¦•à¦°à§‹à¥¤", "warn");
    }

    const ref = getRefFromURL();

    db.users[userName] = {
      pass,
      points: NEW_ACCOUNT_BONUS,
      lifetime: NEW_ACCOUNT_BONUS,
      lastTick: now(),
      owned: [],
      history: [{t:now(), action:"New account bonus", change:`+${NEW_ACCOUNT_BONUS}`}],
      withdraws: [],
      referredBy: ref || null
    };

    // referral bonus to referrer (if ref exists and ref user exists)
    if(ref && db.users[ref] && ref !== userName){
      db.users[ref].points += REF_BONUS_TO_REFERRER;
      db.users[ref].lifetime += REF_BONUS_TO_REFERRER;
      db.users[ref].history.unshift({t:now(), action:`Referral bonus (from ${userName})`, change:`+${REF_BONUS_TO_REFERRER}`});
      // track ref count locally (browser)
      db.users[ref].refCount = (db.users[ref].refCount||0) + 1;
    }

    db.session = userName;
    db.deviceUsed = true; // lock after first register on this device
    saveDB(db);

    setMsg("Registered âœ… Bonus added + Logged in", "good");
    showLoader("Entering dashboard...");
    setTimeout(()=>{
      hideLoader();
      enterApp();
    }, 900);
  }

  function login(){
    const db = loadDB();
    const userName = (q("uName").value||"").trim().toLowerCase();
    const pass = (q("uPass").value||"").trim();

    if(!db.users[userName]) return setMsg("User à¦ªà¦¾à¦“à§Ÿà¦¾ à¦¯à¦¾à§Ÿà¦¨à¦¿à¥¤", "bad");
    if(db.users[userName].pass !== pass) return setMsg("Password à¦­à§à¦²à¥¤", "bad");

    db.session = userName;
    db.users[userName].lastTick = now();
    saveDB(db);

    setMsg("Login successful âœ…", "good");
    showLoader("Loading your account...");
    setTimeout(()=>{
      hideLoader();
      enterApp();
    }, 700);
  }

  function logout(){
    const db = loadDB();
    db.session = null;
    saveDB(db);
    backToLanding();
  }

  function resetAll(){
    localStorage.removeItem(DBKEY);
    localStorage.removeItem("pe_device_id");
    setMsg("All data reset âœ…", "warn");
    setLandingStats();
  }

  function goAppIfLogged(){
    const db = loadDB();
    if(!db.session) return setMsg("à¦†à¦—à§‡ Login à¦•à¦°à§‹à¥¤", "warn");
    showLoader("Opening dashboard...");
    setTimeout(()=>{ hideLoader(); enterApp(); }, 600);
  }

  function enterApp(){
    q("landing").classList.add("hide");
    q("app").classList.remove("hide");
    openTab("shop");
    renderAll();
  }

  function backToLanding(){
    q("app").classList.add("hide");
    q("landing").classList.remove("hide");
    setLandingStats();
    setReferralLinkUI();
  }

  // --------------------------
  // Render All
  // --------------------------
  function renderHeader(){
    const db = loadDB();
    const user = getUser(db);

    if(!user){
      q("who").textContent = "User: Guest";
      q("points").textContent = "0";
      q("rate").textContent = "0";
      q("balBox").textContent = "0";
      q("rateBox").textContent = "0";
      q("refCount").textContent = "0";
      setReferralLinkUI();
      return;
    }

    accrue(db);
    saveDB(db);

    const r = computeRate(user);
    q("who").textContent = "User: " + db.session;
    q("points").textContent = fmtInt(user.points);
    q("rate").textContent = fmtInt(r);
    q("balBox").textContent = fmtInt(user.points);
    q("rateBox").textContent = fmtInt(r);
    q("refCount").textContent = String(user.refCount || 0);
    setReferralLinkUI();
  }

  function renderAll(){
    renderHeader();
    renderShop();
    renderInventory();
    renderLeaderboard();
    renderHistory();
    renderWithdrawTable();
  }

  // --------------------------
  // Tick loop
  // --------------------------
  setInterval(()=>{
    const db = loadDB();
    if(db.session){
      accrue(db);
      saveDB(db);
      renderHeader();
    }
  }, 1000);

  // init
  (function init(){
    setLandingStats();
    setReferralLinkUI();
    const db = loadDB();
    if(db.session && !db.users[db.session]){
      db.session = null;
      saveDB(db);
    }
  })();
</script>
</body>
